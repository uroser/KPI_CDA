<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUB DE AMIGOS [Gestión de Área] - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* * Paleta de Colores Basada en el Logo
         * Azul Primario: #004A99
         * Naranja de Acento: #F37A20
         * Fondos Claros: #f0f2f5
         * Texto Principal: #333
        */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .header {
            background-color: #ffffff;
            color: #004A99;
            padding: 1rem;
            border-bottom: 4px solid #F37A20;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 2rem;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        .kpi-card {
            background-color: #e9ecef;
            border-radius: 0.75rem;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .kpi-card.solved {
            background-color: #d4edda;
        }
        .kpi-card.pending {
            background-color: #fff3cd;
        }
        .kpi-card.in-process {
            background-color: #E6F0FA; /* Azul claro derivado del primario */
        }
        .kpi-card.cancelled {
            background-color: #f8d7da;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #004A99; /* Azul Primario */
            margin-top: 0.5rem;
        }
        .kpi-label {
            font-size: 1rem;
            color: #555;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 1.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            text-align: left;
            font-size: 0.9rem;
        }
        th {
            background-color: #f8f8f8;
            font-weight: 600;
            color: #4a5568;
        }
        tr:nth-child(even) {
            background-color: #fbfbfb;
        }
        .file-input-wrapper, .filter-controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .file-input-button, .filter-button {
            background-color: #F37A20; /* Naranja de Acento */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 600;
            margin: 0.5rem;
        }
        .file-input-button:hover, .filter-button:hover {
            background-color: #D9681C; /* Naranja más oscuro para hover */
        }
        .hidden-input {
            display: none;
        }
        .filter-controls label {
            margin-right: 0.5rem;
            font-weight: 600;
            color: #4a5568;
        }
        .filter-controls input[type="date"] {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            margin-right: 1rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 1.5rem;
            color: #004A99; /* Azul Primario */
            display: none;
        }
        .top-list ol {
            list-style: decimal;
            padding-left: 1.5rem;
        }
        .top-list li {
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: #555;
        }
        .top-list li strong {
            color: #004A99; /* Azul Primario */
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 1000px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            position: relative;
            animation-name: animatetop;
            animation-duration: 0.4s
        }
        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #004A99; /* Azul Primario */
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">Cargando datos...</div>

    <div class="header">
        <img src="https://www.clubdeamigos.org.ar/img/logo-header.png?i=111112" alt="Logo Club de Amigos" class="mx-auto h-20">
        <p class="text-xl mt-4">FACILITIES MANAGER - Control de Gestión </p>
    </div>

    <div class="container">
        <div class="file-input-wrapper">
            <label for="fileUpload" class="file-input-button">
                Cargar Archivo
            </label>
            <input type="file" id="fileUpload" accept=".html" class="hidden-input">
        </div>

        <div class="filter-controls">
            <label for="startDate">Fecha Desde:</label>
            <input type="date" id="startDate">
            <label for="endDate">Fecha Hasta:</label>
            <input type="date" id="endDate">
            <button id="applyFilters" class="filter-button">Aplicar Filtros</button>
        </div>

        <div class="kpi-grid" id="kpiGrid">
            </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="card cursor-pointer" data-chart-type="category">
                <h2 class="text-2xl font-semibold mb-4">Requerimientos por Categoría</h2>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <div class="card cursor-pointer" data-chart-type="status">
                <h2 class="text-2xl font-semibold mb-4">Requerimientos por Estado</h2>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <div class="card cursor-pointer" data-chart-type="management">
                <h2 class="text-2xl font-semibold mb-4">Requerimientos por Gerencia</h2>
                <div class="chart-container">
                    <canvas id="managementChart"></canvas>
                </div>
            </div>

            <div class="card cursor-pointer" data-chart-type="monthly">
                <h2 class="text-2xl font-semibold mb-4">Requerimientos Mensuales</h2>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <div class="card cursor-pointer" data-chart-type="type">
                <h2 class="text-2xl font-semibold mb-4">Requerimientos por Tipo</h2>
                <div class="chart-container">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">Top 5 Solicitantes</h2>
                <div id="topSolicitantes" class="top-list">
                    </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">Top 5 Categorías</h2>
                <div id="topCategorias" class="top-list">
                    </div>
            </div>
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">Top 5 Asignados</h2>
                <div id="topAsignados" class="top-list">
                    </div>
            </div>
             <div class="card">
                <h2 class="text-2xl font-semibold mb-4">Top 5 Ubicaciones</h2>
                <div id="topUbicaciones" class="top-list">
                    </div>
            </div>
        </div>
    </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalTitle" class="modal-title">Detalles</h3>
            <div class="table-container">
                <table id="modalTable">
                    <thead>
                        <tr>
                            <th>Fecha Ingreso</th>
                            <th>Ticket</th>
                            <th>Asignado A</th>
                            <th>Estado</th>
                            <th>Prioridad</th>
                            <th>Tipo</th>
                            <th>Categoría</th>
                            <th>Ubicación</th>
                            <th>Sector</th>
                            <th>Solicitante</th>
                            <th>Gerencia</th>
                            <th>Descripción</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Avance (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let categoryChartInstance = null;
        let statusChartInstance = null;
        let managementChartInstance = null;
        let monthlyChartInstance = null;
        let typeChartInstance = null; // New chart instance
        let allRequirementsData = []; // Store all parsed data
        let currentFilteredData = []; // Store currently filtered data

        // Nueva paleta de colores para gráficos
        const chartColorPalette = ['#004A99', '#F37A20', '#5DADE2', '#FAD7A0', '#48C9B0', '#A569BD', '#F1948A', '#7F8C8D'];

        document.addEventListener('DOMContentLoaded', () => {
            Chart.register(ChartDataLabels);

            document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
            document.getElementById('applyFilters').addEventListener('click', applyDateFilters);

            // Get the modal
            const modal = document.getElementById("detailsModal");
            const span = document.getElementsByClassName("close-button")[0];

            // When the user clicks on <span> (x), close the modal
            span.onclick = function() {
                modal.style.display = "none";
            }

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        });

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            showLoading();

            const reader = new FileReader();
            reader.onload = async (e) => {
                const htmlContent = e.target.result;
                await processHtmlContent(htmlContent);
                hideLoading();
            };
            reader.readAsText(file);
        }

        function parseDate(dateString) {
            // Expected format: DD-MM-YYYY
            if (!dateString) return null;
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                const year = parseInt(parts[2], 10);
                return new Date(year, month, day);
            }
            return null;
        }

        async function processHtmlContent(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const table = doc.querySelector('table');

            if (!table) {
                console.error('No se encontró la tabla en el archivo HTML.');
                hideLoading();
                return;
            }

            const rows = Array.from(table.querySelectorAll('tbody tr'));
            allRequirementsData = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                return {
                    fechaIngreso: cells[0]?.textContent.trim() || '',
                    ticket: cells[1]?.textContent.trim() || '',
                    asignadoA: cells[2]?.textContent.trim() || '',
                    estado: cells[3]?.textContent.trim() || '',
                    prioridad: cells[4]?.textContent.trim() || '',
                    tipo: cells[5]?.textContent.trim() || '',
                    categoria: cells[6]?.textContent.trim() || '',
                    ubicacion: cells[7]?.textContent.trim() || '',
                    sector: cells[8]?.textContent.trim() || '',
                    solicitante: cells[9]?.textContent.trim() || '',
                    gerencia: cells[10]?.textContent.trim() || '',
                    descripcion: cells[11]?.textContent.trim().replace(/<\/?p>/g, '') || '',
                    fechaInicio: cells[12]?.textContent.trim() || '',
                    fechaFin: cells[13]?.textContent.trim() || '',
                    avance: parseInt(cells[14]?.textContent.trim()) || 0,
                    parsedFechaIngreso: parseDate(cells[0]?.textContent.trim())
                };
            }).filter(row => row.fechaIngreso !== '');

            if (allRequirementsData.length > 0) {
                const dates = allRequirementsData.map(d => d.parsedFechaIngreso).filter(d => d !== null);
                if (dates.length > 0) {
                    const minDate = new Date(Math.min(...dates));
                    const maxDate = new Date(Math.max(...dates));

                    document.getElementById('startDate').value = minDate.toISOString().split('T')[0];
                    document.getElementById('endDate').value = maxDate.toISOString().split('T')[0];
                }
            }

            renderDashboard(allRequirementsData);
        }

        function applyDateFilters() {
            showLoading();
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;

            const startDate = startDateStr ? new Date(startDateStr) : null;
            const endDate = endDateStr ? new Date(endDateStr) : null;

            currentFilteredData = allRequirementsData.filter(req => {
                if (!req.parsedFechaIngreso) return false;
                const reqDate = new Date(req.parsedFechaIngreso.getFullYear(), req.parsedFechaIngreso.getMonth(), req.parsedFechaIngreso.getDate());
                const startsOk = startDate ? reqDate >= startDate : true;
                const endsOk = endDate ? reqDate <= endDate : true;
                return startsOk && endsOk;
            });

            renderDashboard(currentFilteredData);
            hideLoading();
        }

        function renderDashboard(data) {
            currentFilteredData = data; // Update current filtered data
            updateKPIs(data);
            updateCharts(data);
            updateMonthlyChart(data);
            updateTypeChart(data); // New chart call
            updateTopLists(data);
            attachChartClickEvents(); // Re-attach click events after charts are rendered
        }

        function updateKPIs(data) {
            const total = data.length;
            const solved = data.filter(req => req.estado === 'Solucionado').length;
            const pending = data.filter(req => req.estado === 'Pendiente').length;
            const inProcess = data.filter(req => req.estado === 'En Proceso').length;
            const cancelled = data.filter(req => req.estado === 'Cancelado').length;

            const kpiGrid = document.getElementById('kpiGrid');
            kpiGrid.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Total Requerimientos</div>
                    <div class="kpi-value">${total}</div>
                </div>
                <div class="kpi-card solved">
                    <div class="kpi-label">Solucionados</div>
                    <div class="kpi-value">${solved}</div>
                </div>
                <div class="kpi-card pending">
                    <div class="kpi-label">Pendientes</div>
                    <div class="kpi-value">${pending}</div>
                </div>
                <div class="kpi-card in-process">
                    <div class="kpi-label">En Proceso</div>
                    <div class="kpi-value">${inProcess}</div>
                </div>
                <div class="kpi-card cancelled">
                    <div class="kpi-label">Cancelados</div>
                    <div class="kpi-value">${cancelled}</div>
                </div>
            `;
        }

        function updateCharts(data) {
            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) label += ': ';
                                if (context.parsed !== null) label += context.parsed;
                                return label;
                            }
                        }
                    },
                    datalabels: {
                        formatter: (value, ctx) => {
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(data => { sum += data; });
                            let percentage = (value * 100 / sum).toFixed(2) + "%";
                            return percentage;
                        },
                        color: '#fff',
                        textShadowColor: 'rgba(0,0,0,0.5)',
                        textShadowBlur: 4,
                        font: { weight: 'bold' }
                    }
                },
                onClick: (e, elements, chart) => handleChartClick(e, elements, chart)
            };

            // Requerimientos por Categoría
            const categoryCounts = data.reduce((acc, req) => {
                const category = req.categoria || 'Sin Categoría';
                acc[category] = (acc[category] || 0) + 1;
                return acc;
            }, {});
            const categoryLabels = Object.keys(categoryCounts);
            const categoryValues = Object.values(categoryCounts);

            if (categoryChartInstance) categoryChartInstance.destroy();
            categoryChartInstance = new Chart(document.getElementById('categoryChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: categoryLabels,
                    datasets: [{ label: 'Número de Requerimientos', data: categoryValues, backgroundColor: '#004A99', borderColor: '#003366', borderWidth: 1 }]
                },
                options: { ...commonChartOptions,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Cantidad' } },
                        x: { title: { display: true, text: 'Categoría' } }
                    },
                    plugins: { ...commonChartOptions.plugins, legend: { display: false }, datalabels: { display: false } }
                }
            });

            // Requerimientos por Estado
            const statusCounts = data.reduce((acc, req) => {
                const status = req.estado || 'Desconocido';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            const statusLabels = Object.keys(statusCounts);
            const statusValues = Object.values(statusCounts);
            const statusColors = statusLabels.map(label => {
                switch (label) {
                    case 'Solucionado': return '#28a745'; case 'Pendiente': return '#ffc107';
                    case 'En Proceso': return '#004A99'; case 'Cancelado': return '#dc3545';
                    default: return '#6c757d';
                }
            });

            if (statusChartInstance) statusChartInstance.destroy();
            statusChartInstance = new Chart(document.getElementById('statusChart').getContext('2d'), {
                type: 'pie',
                data: { labels: statusLabels, datasets: [{ label: 'Requerimientos por Estado', data: statusValues, backgroundColor: statusColors, hoverOffset: 4 }] },
                options: commonChartOptions
            });

            // Requerimientos por Gerencia
            const managementCounts = data.reduce((acc, req) => {
                const management = req.gerencia || 'Sin Gerencia';
                acc[management] = (acc[management] || 0) + 1;
                return acc;
            }, {});
            const managementLabels = Object.keys(managementCounts);
            const managementValues = Object.values(managementCounts);

            if (managementChartInstance) managementChartInstance.destroy();
            managementChartInstance = new Chart(document.getElementById('managementChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: managementLabels,
                    datasets: [{
                        label: 'Requerimientos por Gerencia',
                        data: managementValues,
                        backgroundColor: chartColorPalette,
                        hoverOffset: 4
                    }]
                },
                options: commonChartOptions
            });
        }

        function updateMonthlyChart(data) {
            const monthlyCounts = data.reduce((acc, req) => {
                if (req.parsedFechaIngreso) {
                    const monthYear = `${req.parsedFechaIngreso.getFullYear()}-${(req.parsedFechaIngreso.getMonth() + 1).toString().padStart(2, '0')}`;
                    acc[monthYear] = (acc[monthYear] || 0) + 1;
                }
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlyCounts).sort();
            const monthlyValues = sortedMonths.map(month => monthlyCounts[month]);

            if (monthlyChartInstance) monthlyChartInstance.destroy();
            monthlyChartInstance = new Chart(document.getElementById('monthlyChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{ label: 'Número de Requerimientos', data: monthlyValues, backgroundColor: 'rgba(243, 122, 32, 0.2)', borderColor: '#F37A20', borderWidth: 2, fill: true, tension: 0.4 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Cantidad' } },
                        x: { title: { display: true, text: 'Mes' } }
                    },
                    plugins: { legend: { display: false }, datalabels: { display: false } },
                    onClick: (e, elements, chart) => handleChartClick(e, elements, chart)
                }
            });
        }

        function updateTypeChart(data) {
            const typeCounts = data.reduce((acc, req) => {
                const type = req.tipo || 'Sin Tipo';
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});
            const typeLabels = Object.keys(typeCounts);
            const typeValues = Object.values(typeCounts);
            
            if (typeChartInstance) typeChartInstance.destroy();
            typeChartInstance = new Chart(document.getElementById('typeChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: typeLabels,
                    datasets: [{ label: 'Requerimientos por Tipo', data: typeValues, backgroundColor: chartColorPalette, hoverOffset: 4 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) label += context.parsed;
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                let sum = 0;
                                let dataArr = ctx.chart.data.datasets[0].data;
                                dataArr.map(data => { sum += data; });
                                let percentage = (value * 100 / sum).toFixed(2) + "%";
                                return percentage;
                            },
                            color: '#fff',
                            textShadowColor: 'rgba(0,0,0,0.5)',
                            textShadowBlur: 4,
                            font: { weight: 'bold' }
                        }
                    },
                    onClick: (e, elements, chart) => handleChartClick(e, elements, chart)
                }
            });
        }

        function updateTopLists(data) {
            const getTopN = (dataArray, key, n = 5) => {
                const counts = dataArray.reduce((acc, item) => {
                    const value = item[key] || 'Desconocido';
                    acc[value] = (acc[value] || 0) + 1;
                    return acc;
                }, {});

                return Object.entries(counts)
                    .sort(([, countA], [, countB]) => countB - countA)
                    .slice(0, n);
            };

            document.getElementById('topSolicitantes').innerHTML = '<ol>' + getTopN(data, 'solicitante').map(([name, count]) => `<li><strong>${name}</strong>: ${count} requerimientos</li>`).join('') + '</ol>';
            document.getElementById('topCategorias').innerHTML = '<ol>' + getTopN(data, 'categoria').map(([name, count]) => `<li><strong>${name}</strong>: ${count} requerimientos</li>`).join('') + '</ol>';
            document.getElementById('topAsignados').innerHTML = '<ol>' + getTopN(data, 'asignadoA').map(([name, count]) => `<li><strong>${name}</strong>: ${count} requerimientos</li>`).join('') + '</ol>';
            document.getElementById('topUbicaciones').innerHTML = '<ol>' + getTopN(data, 'ubicacion').map(([name, count]) => `<li><strong>${name}</strong>: ${count} requerimientos</li>`).join('') + '</ol>';
        }

        function updateModalTable(dataToShow, title) {
            const modal = document.getElementById("detailsModal");
            const modalTitle = document.getElementById("modalTitle");
            const modalTableBody = document.querySelector('#modalTable tbody');

            modalTitle.textContent = title;
            modalTableBody.innerHTML = '';

            dataToShow.forEach(req => {
                const row = modalTableBody.insertRow();
                row.insertCell().textContent = req.fechaIngreso;
                row.insertCell().textContent = req.ticket;
                row.insertCell().textContent = req.asignadoA;
                row.insertCell().textContent = req.estado;
                row.insertCell().textContent = req.prioridad;
                row.insertCell().textContent = req.tipo;
                row.insertCell().textContent = req.categoria;
                row.insertCell().textContent = req.ubicacion;
                row.insertCell().textContent = req.sector;
                row.insertCell().textContent = req.solicitante;
                row.insertCell().textContent = req.gerencia;
                row.insertCell().textContent = req.descripcion;
                row.insertCell().textContent = req.fechaInicio;
                row.insertCell().textContent = req.fechaFin;
                row.insertCell().textContent = req.avance;
            });

            modal.style.display = "flex"; // Show the modal
        }

        function handleChartClick(evt, elements, chart) {
            if (elements.length > 0) {
                const clickedElementIndex = elements[0].index;
                const label = chart.data.labels[clickedElementIndex];
                let filteredDetails = [];
                let modalChartTitle = "";

                switch(chart.canvas.id) {
                    case 'categoryChart':
                        filteredDetails = currentFilteredData.filter(req => (req.categoria || 'Sin Categoría') === label);
                        modalChartTitle = `Detalles para Categoría: ${label}`;
                        break;
                    case 'statusChart':
                        filteredDetails = currentFilteredData.filter(req => (req.estado || 'Desconocido') === label);
                        modalChartTitle = `Detalles para Estado: ${label}`;
                        break;
                    case 'managementChart':
                        filteredDetails = currentFilteredData.filter(req => (req.gerencia || 'Sin Gerencia') === label);
                        modalChartTitle = `Detalles para Gerencia: ${label}`;
                        break;
                    case 'monthlyChart':
                        filteredDetails = currentFilteredData.filter(req => {
                            if (!req.parsedFechaIngreso) return false;
                            const monthYear = `${req.parsedFechaIngreso.getFullYear()}-${(req.parsedFechaIngreso.getMonth() + 1).toString().padStart(2, '0')}`;
                            return monthYear === label;
                        });
                        modalChartTitle = `Detalles para Mes: ${label}`;
                        break;
                    case 'typeChart':
                        filteredDetails = currentFilteredData.filter(req => (req.tipo || 'Sin Tipo') === label);
                        modalChartTitle = `Detalles para Tipo: ${label}`;
                        break;
                }
                updateModalTable(filteredDetails, modalChartTitle);
            }
        }

        // Helper to attach click events to all chart canvases
        function attachChartClickEvents() {
            const chartCanvases = document.querySelectorAll('canvas');
            chartCanvases.forEach(canvas => {
                const chart = Chart.getChart(canvas);
                if (chart) {
                    // Chart.js handles the click internally via its options.onClick
                }
            });
        }
    </script>
</body>
</html>
