<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUB DE AMIGOS - Dashboard de Facilities</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Paleta de Colores y Estilos Generales */
        :root {
            --color-primary: #004A99;
            --color-accent: #F37A20;
            --color-background: #f4f7f9;
            --color-text: #343a40;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
        }

        .header {
            color: white;
            padding: 2rem;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        .header-bg {
            background-image: linear-gradient(to right, rgba(0, 30, 60, 0.85), rgba(0, 74, 153, 0.65)), url('https://www.clubdeamigos.org.ar/contenido/grande/4450291.jpg');
            background-size: cover;
            background-position: center;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
        }

        .container-main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        /* Estilos de Botones de Acción */
        .action-button {
            background-color: var(--color-accent); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer;
            transition: all 0.3s ease; font-weight: 600;
        }
        .action-button:hover { background-color: #D9681C; transform: translateY(-2px); }
        .clear-button { background-color: #6c757d; }
        .clear-button:hover { background-color: #5a6268; }

        /* Estilos para la sección de KPIs */
        .kpi-section-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--color-accent);
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
        }
        @media (min-width: 1280px) { .kpi-grid { grid-template-columns: repeat(8, 1fr); } }
        .kpi-card {
            border-radius: 0.75rem; padding: 1.25rem; text-align: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .kpi-card.clickable { cursor: pointer; }
        .kpi-card.clickable:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); }
        .kpi-card.solved { background-color: #d4edda; border-left: 5px solid #155724; }
        .kpi-card.pending { background-color: #fff3cd; border-left: 5px solid #856404; }
        .kpi-card.in-process { background-color: #E6F0FA; border-left: 5px solid #004A99; }
        .kpi-card.cancelled { background-color: #f8d7da; border-left: 5px solid #721c24; }
        .kpi-value { font-size: 2.5rem; font-weight: 700; color: var(--color-primary); margin-top: 0.5rem; }
        .kpi-label { font-size: 1rem; color: #555; font-weight: 500;}

        /* Estilos de Gráficos y Tablas */
        .chart-container { position: relative; height: 400px; width: 100%; flex-grow: 1; }
        .chart-container-large { position: relative; height: 600px; width: 100%; flex-grow: 1; }
        .table-container { overflow-x: auto; margin-top: 1.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; border: 1px solid #e2e8f0; text-align: left; font-size: 0.9rem; word-wrap: break-word; }
        th { background-color: #f8f8f8; font-weight: 600; color: #4a5568; }

        /* Estilos de Filtros */
        #filtersContainer {
            transition: all 0.4s ease-out;
            max-height: 0;
            overflow: hidden;
            padding: 0;
            border: none;
            margin-bottom: 0;
        }
        #filtersContainer.open {
            max-height: 500px; 
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e9ecef;
        }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 0.25rem; font-weight: 600; font-size: 0.875rem; color: #4a5568; }
        .filter-group input, .filter-group select { padding: 0.5rem; border: 1px solid #ccc; border-radius: 0.5rem; min-width: 150px; }
        
        /* Icono de Zoom */
        .zoom-icon {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #ccc;
            transition: color 0.2s, transform 0.2s;
            z-index: 10;
        }
        .zoom-icon:hover { color: var(--color-primary); transform: scale(1.2); }

        /* Estilos Modales */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 8px 16px rgba(0,0,0,0.2); position: relative; animation: animatetop 0.4s; }
        @keyframes animatetop { from {transform: translateY(-50px); opacity: 0} to {transform: translateY(0); opacity: 1} }
        .close-button { color: #aaa; position: absolute; top: 1rem; right: 1.5rem; font-size: 28px; font-weight: bold; cursor: pointer; z-index: 1002; }
        .modal-title { font-size: 1.75rem; font-weight: 600; margin-bottom: 1rem; color: var(--color-primary); }
        
        #detailsModal { z-index: 1005; }
        #detailsModal .modal-content { width: 95vw; max-width: 95vw; }
        
        #chartZoomModal .modal-content {
            width: 90vw;
            height: 90vh;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        #zoomModalContent {
            flex-grow: 1;
            position: relative;
            display: flex;
        }
        .card.is-zoomed {
            width: 100%;
            height: 100%;
            margin-bottom: 0;
        }
        .card.is-zoomed .zoom-icon {
            display: none;
        }

        #modalTable thead th:nth-child(1),
        #modalTable thead th:nth-child(13) {
            background-color: #dbeafe; /* Light blue */
            color: #1e3a8a;
        }
        #modalTable th:nth-child(12) { width: 30%; }

        .table-cell-content {
            max-height: 7.5em; /* 1.5em line-height * 5 lines */
            line-height: 1.5em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            text-overflow: ellipsis;
        }
        td.status-solved { background-color: #d4edda; }
        td.status-pending { background-color: #fff3cd; }
        td.status-in-process { background-color: #E6F0FA; }
        td.status-cancelled { background-color: #f8d7da; }
        
        .top-list ol { list-style: decimal; padding-left: 1.5rem; }
        .top-list li { margin-bottom: 0.5rem; font-size: 1rem; color: #555; }
        .top-list li.clickable { cursor: pointer; padding: 0.25rem; border-radius: 0.25rem; }
        .top-list li.clickable:hover { background-color: #f0f0f0; }
        .top-list li strong { color: var(--color-primary); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center; z-index: 10000; font-size: 1.5rem; color: var(--color-primary); display: none; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">Cargando datos...</div>

    <header class="header">
        <div class="header-bg"></div>
        <div class="flex items-center gap-4">
            <img src="https://www.clubdeamigos.org.ar/img/logo-header.png?i=111112" alt="Logo Club de Amigos" class="h-16 drop-shadow-lg">
            <div>
                <h1 class="text-2xl font-bold">Dashboard de Facilities</h1>
                <p class="text-sm opacity-80">Club de Amigos</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button id="toggleFiltersBtn" class="action-button">
                <i class="fas fa-filter mr-2"></i>Filtros
            </button>
            <label for="fileUpload" class="action-button bg-blue-600 hover:bg-blue-700">
                <i class="fas fa-upload mr-2"></i>Cargar Archivo
            </label>
            <input type="file" id="fileUpload" accept=".html" class="hidden">
        </div>
    </header>

    <div class="container-main">
        <div id="filtersContainer" class="card">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 items-end">
                <div class="filter-group"><label for="startDate">Fecha Desde:</label><input type="date" id="startDate"></div>
                <div class="filter-group"><label for="endDate">Fecha Hasta:</label><input type="date" id="endDate"></div>
                <div class="filter-group"><label for="filterStatus">Estado:</label><select id="filterStatus"></select></div>
                <div class="filter-group"><label for="filterAssignedTo">Asignado A:</label><select id="filterAssignedTo"></select></div>
                <div class="filter-group"><label for="filterCategory">Categoría:</label><select id="filterCategory"></select></div>
                <div class="filter-group"><label for="filterManagement">Gerencia:</label><select id="filterManagement"></select></div>
                <div class="filter-group"><label for="filterLocation">Ubicación:</label><select id="filterLocation"></select></div>
                <div class="filter-group"><label for="filterSector">Sector:</label><select id="filterSector"></select></div>
                <button id="applyFilters" class="action-button">Aplicar</button>
                <button id="clearFilters" class="action-button clear-button">Limpiar</button>
            </div>
        </div>

        <div id="dashboardContent" class="hidden">
            <div class="card">
                <h2 class="kpi-section-title">Indicadores Clave de Rendimiento (KPIs)</h2>
                <div class="kpi-grid" id="kpiGrid"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <div class="card"><div class="zoom-icon" title="Agrandar gráfico"><i class="fas fa-expand-alt"></i></div><h2 class="text-xl font-semibold mb-4">Tickets por Categoría</h2><div class="chart-container"><canvas id="categoryChart"></canvas></div></div>
                <div class="card"><div class="zoom-icon" title="Agrandar gráfico"><i class="fas fa-expand-alt"></i></div><h2 class="text-xl font-semibold mb-4">Tickets por Estado</h2><div class="chart-container"><canvas id="statusChart"></canvas></div></div>
                <div class="card"><div class="zoom-icon" title="Agrandar gráfico"><i class="fas fa-expand-alt"></i></div><h2 class="text-xl font-semibold mb-4">Tickets por Gerencia</h2><div class="chart-container"><canvas id="managementChart"></canvas></div></div>
                <div class="card"><div class="zoom-icon" title="Agrandar gráfico"><i class="fas fa-expand-alt"></i></div><h2 class="text-xl font-semibold mb-4">Tickets por Tipo</h2><div class="chart-container"><canvas id="typeChart"></canvas></div></div>
                <div class="card lg:col-span-2"><div class="zoom-icon" title="Agrandar gráfico"><i class="fas fa-expand-alt"></i></div><h2 class="text-xl font-semibold mb-4">Top 20 Tickets por Sector</h2><div class="chart-container"><canvas id="sectorChart"></canvas></div></div>
                <div class="card lg:col-span-2"><div class="zoom-icon" title="Agrandar gráfico"><i class="fas fa-expand-alt"></i></div><h2 class="text-xl font-semibold mb-4">Tickets Mensuales</h2><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
                <div class="card lg:col-span-2"><div class="zoom-icon" title="Agrandar gráfico"><i class="fas fa-expand-alt"></i></div><h2 class="text-xl font-semibold mb-4">Top 10 Requerimientos con Mayor Tiempo de Resolución (en días)</h2><div class="chart-container"><canvas id="resolutionTimeChart"></canvas></div></div>
                <div class="card lg:col-span-2"><div class="zoom-icon" title="Agrandar gráfico"><i class="fas fa-expand-alt"></i></div><h2 class="text-xl font-semibold mb-4">Total de Tickets por Colaborador</h2><div class="chart-container-large"><canvas id="assignedToChart"></canvas></div></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                 <div class="card"><h2 class="text-xl font-semibold mb-4">Top 5 Solicitantes</h2><div id="topSolicitantes" class="top-list"></div></div>
                 <div class="card"><h2 class="text-xl font-semibold mb-4">Top 5 Categorías</h2><div id="topCategorias" class="top-list"></div></div>
                 <div class="card"><h2 class="text-xl font-semibold mb-4">Top 5 Asignados</h2><div id="topAsignados" class="top-list"></div></div>
            </div>
        </div>
    </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeDetailsModal">&times;</span>
            <h3 id="modalTitle" class="modal-title">Detalles</h3>
            <div class="table-container">
                <table id="modalTable">
                    <thead>
                        <tr>
                            <th>FECHA DE INGRESO</th><th>TICKET</th><th>ASIGNADO A</th><th>ESTADO</th><th>PRIORIDAD</th>
                            <th>TIPO</th><th>CATEGORIA</th><th>UBICACION</th><th>SECTOR</th><th>SOLICITANTE</th>
                            <th>GERENCIA</th><th>DESCRIPCION</th><th>FECHA INICIO</th><th>FECHA FIN</th><th>AVANCE (%)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="chartZoomModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeChartZoomModal">&times;</span>
            <div id="zoomModalContent">
            </div>
        </div>
    </div>

    <script>
        let categoryChartInstance, statusChartInstance, managementChartInstance, monthlyChartInstance,
            resolutionTimeChartInstance, assignedToChartInstance,
            typeChartInstance, sectorChartInstance;

        let allRequirementsData = [];
        let currentFilteredData = [];
        const chartColorPalette = ['#004A99', '#F37A20', '#5DADE2', '#FAD7A0', '#48C9B0', '#A569BD', '#F1948A', '#7F8C8D'];
        
        let zoomedElement = null;
        let originalParent = null;
        let originalNextSibling = null;

        document.addEventListener('DOMContentLoaded', () => {
            Chart.register(ChartDataLabels);
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            document.getElementById('toggleFiltersBtn').addEventListener('click', () => {
                document.getElementById('filtersContainer').classList.toggle('open');
            });

            const detailsModal = document.getElementById("detailsModal");
            document.getElementById("closeDetailsModal").onclick = () => detailsModal.style.display = "none";
            
            const chartZoomModal = document.getElementById("chartZoomModal");
            document.getElementById("closeChartZoomModal").onclick = closeZoomModal;

            window.onclick = (event) => {
                if (event.target == detailsModal) detailsModal.style.display = "none";
                if (event.target == chartZoomModal) closeZoomModal();
            };
            
            document.querySelectorAll('.zoom-icon').forEach(icon => {
                icon.addEventListener('click', handleChartZoom);
            });
        }
        
        function handleChartZoom(event) {
            const cardElement = event.currentTarget.closest('.card');
            if (!cardElement) return;
            const modalContent = document.getElementById('zoomModalContent');
            modalContent.innerHTML = '';
            zoomedElement = cardElement;
            originalParent = cardElement.parentNode;
            originalNextSibling = cardElement.nextElementSibling;
            modalContent.appendChild(cardElement); 
            zoomedElement.classList.add('is-zoomed');
            document.getElementById('chartZoomModal').style.display = 'flex';
            const canvasId = cardElement.querySelector('canvas').id;
            const chartInstance = Chart.getChart(canvasId);
            if (chartInstance) {
                chartInstance.resize();
            }
        }

        function closeZoomModal() {
            const chartZoomModal = document.getElementById('chartZoomModal');
            if (!chartZoomModal || chartZoomModal.style.display === 'none') return;
            if (zoomedElement) {
                zoomedElement.classList.remove('is-zoomed');
                if (originalNextSibling) {
                    originalParent.insertBefore(zoomedElement, originalNextSibling);
                } else {
                    originalParent.appendChild(zoomedElement);
                }
                const canvasId = zoomedElement.querySelector('canvas').id;
                const chartInstance = Chart.getChart(canvasId);
                if (chartInstance) {
                    chartInstance.resize();
                }
                zoomedElement = null;
                originalParent = null;
                originalNextSibling = null;
            }
            const modalContent = document.getElementById('zoomModalContent');
            if(modalContent) modalContent.innerHTML = '';
            chartZoomModal.style.display = 'none';
        }

        const showLoading = () => document.getElementById('loadingOverlay').style.display = 'flex';
        const hideLoading = () => document.getElementById('loadingOverlay').style.display = 'none';

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showLoading();
            const reader = new FileReader();
            reader.onload = async (e) => {
                await processHtmlContent(e.target.result);
                hideLoading();
            };
            reader.readAsText(file);
        }

        function parseDate(dateString) {
            if (!dateString || dateString.trim() === '') return null;
            const parts = dateString.split(/[-/]/);
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const year = parseInt(parts[2], 10);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(Date.UTC(year, month, day));
                }
            }
            return null;
        }

        async function processHtmlContent(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const table = doc.querySelector('table');
            if (!table) { alert('No se encontró una tabla en el archivo HTML.'); hideLoading(); return; }

            allRequirementsData = Array.from(table.querySelectorAll('tbody tr')).map(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                return {
				fechaIngreso: cells[0]?.textContent.trim() || '',
				ticket: cells[1]?.textContent.trim() || '',
				asignadoA: cells[2]?.textContent.trim() || '',
				estado: cells[3]?.textContent.trim() || '',
				prioridad: cells[4]?.textContent.trim() || '',
				tipo: cells[5]?.textContent.trim() || '',
				categoria: cells[6]?.textContent.trim() || '',
				ubicacion: cells[7]?.textContent.trim() || '',
				sector: cells[8]?.textContent.trim() || '',
				solicitante: cells[9]?.textContent.trim() || '',
				gerencia: cells[10]?.textContent.trim() || '',
				descripcion: cells[11]?.textContent.trim().replace(/<\/?p>/g, '') || '',
				fechaInicio: cells[12]?.textContent.trim() || '', // <-- NUEVO
				fechaFin: cells[13]?.textContent.trim() || '',      // <-- Índice actualizado de 12 a 13
				avance: parseInt(cells[14]?.textContent.trim()) || 0, // <-- Índice actualizado de 13 a 14
				parsedFechaIngreso: parseDate(cells[0]?.textContent.trim()),
				parsedFechaFin: parseDate(cells[13]?.textContent.trim()) // <-- Índice actualizado de 12 a 13
				};
            }).filter(row => row.fechaIngreso && row.parsedFechaIngreso);

            document.getElementById('filtersContainer').classList.add('open');
            document.getElementById('dashboardContent').classList.remove('hidden');
            populateFilters(allRequirementsData);
            applyFilters();
        }

        function populateFilters(data) {
            const filters = {
                'filterStatus': 'estado', 'filterCategory': 'categoria', 'filterManagement': 'gerencia',
                'filterLocation': 'ubicacion', 'filterSector': 'sector', 'filterAssignedTo': 'asignadoA'
            };
            for (const [selectId, dataKey] of Object.entries(filters)) {
                const select = document.getElementById(selectId);
                const uniqueValues = [...new Set(data.map(item => item[dataKey] || 'N/A'))].sort();
                select.innerHTML = '<option value="">Todos</option>';
                uniqueValues.forEach(value => { select.innerHTML += `<option value="${value}">${value}</option>`; });
            }
        }

        function clearFilters() {
            document.getElementById('filtersContainer').querySelectorAll('input[type="date"], select').forEach(el => el.value = '');
            applyFilters();
        }

        function applyFilters() {
            showLoading();
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const startDate = startDateStr ? new Date(startDateStr + 'T00:00:00Z') : null;
            const endDate = endDateStr ? new Date(endDateStr + 'T23:59:59Z') : null;

            const filterValues = {
                estado: document.getElementById('filterStatus').value,
                categoria: document.getElementById('filterCategory').value,
                gerencia: document.getElementById('filterManagement').value,
                ubicacion: document.getElementById('filterLocation').value,
                sector: document.getElementById('filterSector').value,
                asignadoA: document.getElementById('filterAssignedTo').value
            };

            currentFilteredData = allRequirementsData.filter(req => {
                const reqDate = req.parsedFechaIngreso;
                const dateOk = (!startDate || (reqDate && reqDate >= startDate)) && (!endDate || (reqDate && reqDate <= endDate));
                if (!dateOk) return false;
                for (const [key, value] of Object.entries(filterValues)) {
                    if (value && (req[key] || 'N/A') !== value) return false;
                }
                return true;
            });

            setTimeout(() => {
                renderDashboard(currentFilteredData);
                hideLoading();
            }, 50);
        }

        function renderDashboard(data) {
            updateKPIs(data);
            updateAllCharts(data);
            updateTopLists(data);
        }

        function updateKPIs(data) {
            const kpiGrid = document.getElementById('kpiGrid');
            if (data.length === 0) {
                kpiGrid.innerHTML = '<p class="col-span-full text-center p-4">No hay datos para los filtros seleccionados.</p>';
                return;
            }
            
            let average = 0;
            if (data.length > 0) {
                let ticketDates = data.map(t => t.parsedFechaIngreso.getTime());
                let minDate = new Date(Math.min.apply(null, ticketDates));
                let maxDate = new Date(Math.max.apply(null, ticketDates));
                let dayDifference = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
                average = (data.length / (dayDifference > 0 ? dayDifference : 1)).toFixed(1);
            }

            const totalTickets = data.length;
            const solvedTickets = data.filter(r => r.estado === 'Solucionado').length;
            const effectivenessRate = totalTickets > 0 ? ((solvedTickets / totalTickets) * 100).toFixed(1) + '%' : '0%';

            const kpiData = {
                'Total': totalTickets,
                'Solucionado': solvedTickets,
                'Pendiente': data.filter(r => r.estado === 'Pendiente').length,
                'En Proceso': data.filter(r => r.estado === 'En Proceso').length,
				'Postpuesto': data.filter(r => r.estado === 'Postpuesto').length,
                'Cancelado': data.filter(r => r.estado === 'Cancelado').length,
                'Tasa de Efectividad': effectivenessRate,
                'Promedio Diario': average
            };

			const kpiClasses = { 'Solucionado': 'solved', 'Pendiente': 'pending', 'En Proceso': 'in-process', 'Cancelado': 'cancelled', 'Tasa de Efectividad': 'solved', 'Postpuesto': 'pending' }; 
			const clickableKpis = ['Total', 'Solucionado', 'Pendiente', 'En Proceso', 'Cancelado', 'Postpuesto'];
            
            kpiGrid.innerHTML = Object.entries(kpiData).map(([key, value]) => `
                <div class="kpi-card ${kpiClasses[key] || ''} ${clickableKpis.includes(key) ? 'clickable' : ''}" data-kpi-key="${key}">
                    <div class="kpi-label">${key}</div>
                    <div class="kpi-value">${value}</div>
                </div>`).join('');
                
            document.querySelectorAll('.kpi-card.clickable').forEach(card => card.addEventListener('click', handleKpiClick));
        }
        
        function updateTopLists(data) {
            const getTopN = (dataArray, key, n = 5) => Object.entries(dataArray.reduce((acc, item) => {
                const value = item[key] || 'Desconocido';
                acc[value] = (acc[value] || 0) + 1;
                return acc;
            }, {})).sort(([, a], [, b]) => b - a).slice(0, n);

            const renderList = (elementId, dataKey, listData) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.innerHTML = '<ol>' + listData.map(([name, count]) =>
                        `<li class="clickable" data-key="${dataKey}" data-value="${name === 'Desconocido' ? '' : name}">
                            <strong>${name}</strong>: ${count} req.
                         </li>`
                    ).join('') + '</ol>';
                    
                    element.querySelectorAll('li').forEach(li => {
                        li.addEventListener('click', handleTopListItemClick);
                    });
                }
            }

            renderList('topSolicitantes', 'solicitante', getTopN(data, 'solicitante'));
            renderList('topCategorias', 'categoria', getTopN(data, 'categoria'));
            renderList('topAsignados', 'asignadoA', getTopN(data, 'asignadoA'));
        }

        function updateAllCharts(data) {
            const commonPieOptions = { responsive: true, maintainAspectRatio: false, onClick: handleChartClick, plugins: { legend: { position: 'right' }, datalabels: { formatter: (value, ctx) => { let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); let percentage = (value * 100 / sum).toFixed(1) + "%"; return percentage; }, color: '#fff' } } };
            const commonBarOptions = { responsive: true, maintainAspectRatio: false, onClick: handleChartClick, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false }, datalabels: { display: false } } };
            const countBy = (key) => data.reduce((acc, req) => { const value = req[key] || 'N/A'; acc[value] = (acc[value] || 0) + 1; return acc; }, {});

            categoryChartInstance = updateChart(categoryChartInstance, 'categoryChart', 'doughnut', countBy('categoria'), commonPieOptions, { palette: chartColorPalette });
            statusChartInstance = updateChart(statusChartInstance, 'statusChart', 'doughnut', countBy('estado'), commonPieOptions, { colors: (labels) => labels.map(l => ({'Solucionado':'#28a745','Pendiente':'#ffc107','En Proceso':'#004A99','Cancelado':'#dc3545', 'Pospuesto':'#ffc107'}[l]||'#6c757d')) });
            managementChartInstance = updateChart(managementChartInstance, 'managementChart', 'doughnut', countBy('gerencia'), commonPieOptions, { palette: chartColorPalette });
            typeChartInstance = updateChart(typeChartInstance, 'typeChart', 'doughnut', countBy('tipo'), commonPieOptions, { palette: chartColorPalette });

            const sectorCounts = countBy('sector');
            const sortedSectors = Object.entries(sectorCounts).sort(([, a], [, b]) => b - a).slice(0, 20);
            const top20SectorCounts = Object.fromEntries(sortedSectors);
            sectorChartInstance = updateChart(sectorChartInstance, 'sectorChart', 'bar', top20SectorCounts, commonBarOptions, { palette: chartColorPalette });
            
            const monthlyData = data.reduce((acc, req) => { if (req.parsedFechaIngreso) { const month = `${req.parsedFechaIngreso.getUTCFullYear()}-${(req.parsedFechaIngreso.getUTCMonth() + 1).toString().padStart(2, '0')}`; acc[month] = (acc[month] || 0) + 1; } return acc; }, {});
            const monthlyOptions = {
                ...commonBarOptions,
                elements: { line: { tension: 0.3, fill: true, backgroundColor: 'rgba(243, 122, 32, 0.2)', borderColor: '#F37A20' } },
                plugins: {
                    ...commonBarOptions.plugins,
                    datalabels: {
                        display: true,
                        anchor: 'end',
                        align: 'top',
                        color: '#333',
                        font: { weight: 'bold' }
                    }
                }
            };
            monthlyChartInstance = updateChart(monthlyChartInstance, 'monthlyChart', 'line', monthlyData, monthlyOptions);
            
            updateResolutionTimeChart(data);
            updateAssignedToChart(data);
        }

        function updateChart(instance, canvasId, type, dataCounts, options, config = {}) {
            if (instance) instance.destroy();
            const labels = Object.keys(dataCounts).sort((a,b) => (type === 'line' ? a.localeCompare(b) : dataCounts[b] - dataCounts[a]));
            const data = labels.map(label => dataCounts[label]);
            const chartData = {
                labels,
                datasets: [{
                    label: `Tickets`,
                    data,
                    backgroundColor: config.colors ? config.colors(labels) : (config.palette || chartColorPalette),
                }]
            };
            if(type === 'line' && options.elements?.line) {
                Object.assign(chartData.datasets[0], options.elements.line);
            }
            return new Chart(document.getElementById(canvasId), { type, data: chartData, options });
        }

        function updateResolutionTimeChart(data) {
            if (resolutionTimeChartInstance) resolutionTimeChartInstance.destroy();
            const resolvedWithDates = data
                .filter(req => req.estado === 'Solucionado' && req.parsedFechaIngreso && req.parsedFechaFin)
                .map(req => ({ ...req, duration: (req.parsedFechaFin - req.parsedFechaIngreso) / (1000 * 60 * 60 * 24) }))
                .filter(req => req.duration >= 0).sort((a, b) => b.duration - a.duration).slice(0, 10);
            resolutionTimeChartInstance = new Chart(document.getElementById('resolutionTimeChart'), { type: 'bar', data: { labels: resolvedWithDates.map(req => `Ticket #${req.ticket}`), datasets: [{ label: 'Días de resolución', data: resolvedWithDates.map(req => req.duration), backgroundColor: '#F37A20' }] }, options: { indexAxis: 'y', onClick: handleChartClick, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#333', formatter: val => val.toFixed(1) + ' días' } } } });
        }

        function updateAssignedToChart(data) {
            if (assignedToChartInstance) assignedToChartInstance.destroy();
            const assignedCounts = data.reduce((acc, req) => {
                const assigned = (req.asignadoA || '').trim() === '' ? 'No Asignado' : req.asignadoA;
                acc[assigned] = (acc[assigned] || 0) + 1;
                return acc;
            }, {});
            const sortedLabels = Object.keys(assignedCounts).sort((a, b) => assignedCounts[b] - assignedCounts[a]);
            const sortedData = sortedLabels.map(label => assignedCounts[label]);
            assignedToChartInstance = new Chart(document.getElementById('assignedToChart'), { type: 'bar', data: { labels: sortedLabels, datasets: [{ label: 'Requerimientos Asignados', data: sortedData, backgroundColor: '#004A99' }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, onClick: handleChartClick, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#333', font: { weight: 'bold' }, formatter: value => value } }, scales: { x: { beginAtZero: true } } } });
        }

        function updateModalTable(dataToShow, title) {
            const modal = document.getElementById("detailsModal");
            document.getElementById("modalTitle").textContent = title;
            const modalTableBody = document.querySelector('#modalTable tbody');
            
            modalTableBody.innerHTML = dataToShow.length === 0 ? `<tr><td colspan="14" class="text-center">No hay datos para mostrar.</td></tr>`
                : dataToShow.map(req => {
                    let statusClass = '';
                    switch(req.estado) {
                        case 'Solucionado': statusClass = 'status-solved'; break;
                        case 'Pendiente': statusClass = 'status-pending'; break;
                        case 'En Proceso': statusClass = 'status-in-process'; break;
                        case 'Cancelado': statusClass = 'status-cancelled'; break;
                    }
                    const rowData = [
                        req.fechaIngreso, req.ticket, req.asignadoA, req.estado,
                        req.prioridad, req.tipo, req.categoria, req.ubicacion,
                        req.sector, req.solicitante, req.gerencia, req.descripcion,
						req.fechaInicio,
                        req.fechaFin, req.avance
                    ];
                    const cells = rowData.map((cellData, index) => {
                        const isStatusCell = index === 3;
                        const cellClass = isStatusCell ? statusClass : '';
                        return `<td class="${cellClass}"><div class="table-cell-content">${cellData}</div></td>`;
                    }).join('');
                    return `<tr>${cells}</tr>`;
                }).join('');
            modal.style.display = "flex";
        }

        function handleKpiClick(event) {
            const card = event.currentTarget;
            const kpiKey = card.dataset.kpiKey;
            const clickableKpis = ['Total', 'Solucionado', 'Pendiente', 'En Proceso', 'Cancelado', 'No Asignado'];

            if (!kpiKey || !clickableKpis.includes(kpiKey)) return;

            let filteredDetails = [];
            switch(kpiKey) {
                case 'Total': filteredDetails = currentFilteredData; break;
                case 'No Asignado': filteredDetails = currentFilteredData.filter(r => !r.asignadoA || r.asignadoA.trim() === ''); break;
                default: filteredDetails = currentFilteredData.filter(r => r.estado === kpiKey);
            }
            updateModalTable(filteredDetails, `Detalles para: ${kpiKey}`);
        }

        function handleChartClick(evt, elements, chart) {
            if (elements.length === 0) return;
            const { index } = elements[0];
            const label = chart.data.labels[index];
            const chartId = chart.canvas.id;
            let filteredDetails = [];
            let modalChartTitle = "Detalles";

            if (chartId === 'resolutionTimeChart') {
                const ticketNumber = label.replace('Ticket #', '');
                filteredDetails = currentFilteredData.filter(req => req.ticket === ticketNumber);
                modalChartTitle = `Detalles para el Ticket: ${label}`;
            } else if (chartId === 'monthlyChart') {
                filteredDetails = currentFilteredData.filter(req => {
                    if (!req.parsedFechaIngreso) return false;
                    const monthYear = `${req.parsedFechaIngreso.getUTCFullYear()}-${(req.parsedFechaIngreso.getUTCMonth() + 1).toString().padStart(2, '0')}`;
                    return monthYear === label;
                });
                modalChartTitle = `Detalles para el Mes: ${label}`;
            } else {
                const keyMap = { 'categoryChart': 'categoria', 'statusChart': 'estado', 'managementChart': 'gerencia', 'typeChart': 'tipo', 'sectorChart': 'sector', 'assignedToChart': 'asignadoA' };
                const dataKey = keyMap[chartId];
                if (dataKey) {
                    if (label === 'N/A') {
                        filteredDetails = currentFilteredData.filter(req => !req[dataKey] || req[dataKey].trim() === '');
                    } else if (dataKey === 'asignadoA' && label === 'No Asignado') {
                        filteredDetails = currentFilteredData.filter(req => !req.asignadoA || req.asignadoA.trim() === '');
                    } else {
                        filteredDetails = currentFilteredData.filter(req => req[dataKey] === label);
                    }
                    const capitalKey = dataKey.charAt(0).toUpperCase() + dataKey.slice(1);
                    modalChartTitle = `Detalles para ${capitalKey.replace('A', ' a')}: ${label}`;
                }
            }
            updateModalTable(filteredDetails, modalChartTitle);
        }

        function handleTopListItemClick(event) {
            const listItem = event.currentTarget;
            const dataKey = listItem.dataset.key;
            const dataValue = listItem.dataset.value;

            if (!dataKey) return;

            const filteredDetails = currentFilteredData.filter(req => {
                const reqValue = req[dataKey] || '';
                return reqValue === dataValue;
            });

            const capitalKey = dataKey.charAt(0).toUpperCase() + dataKey.slice(1);
            const modalTitle = `Detalles para ${capitalKey.replace('A', ' a')}: ${dataValue || 'Desconocido'}`;

            updateModalTable(filteredDetails, modalTitle);
        }
    </script>
</body>
</html>
